import { diag, } from "@opentelemetry/api";
import { mask } from "./maskingRules";
/**
 * A wrapper around the OpenTelemetry {@link Span} interface that masks sensitive information based on the passed in {@link TraceConfig}.
 */
export class FISpan {
    constructor({ span, config }) {
        this.isEnded = false;
        this.span = span;
        this.config = config;
        const wrappedSpanContext = span.spanContext();
        const isNoOp = wrappedSpanContext.traceFlags === 0 && wrappedSpanContext.spanId === '0000000000000000';
        // diag.debug(
        //     `FISpan CONSTRUCTOR: Wrapping span. ID: ${wrappedSpanContext.spanId}, TraceID: ${wrappedSpanContext.traceId}, TraceFlags: ${wrappedSpanContext.traceFlags}, Is NoOp: ${isNoOp}`
        // );
    }
    setAttribute(key, value) {
        if (this.isEnded) {
            diag.warn(`FISpan.setAttribute called on ended span ID: ${this.span.spanContext().spanId} for key: ${key}`);
            return this;
        }
        const maskedValue = mask({ config: this.config, key, value });
        if (maskedValue != null) {
            this.span.setAttribute(key, maskedValue);
        }
        return this;
    }
    setAttributes(attributes) {
        if (this.isEnded) {
            diag.warn(`FISpan.setAttributes called on ended span ID: ${this.span.spanContext().spanId}`);
            return this;
        }
        const maskedAttributes = Object.entries(attributes).reduce((acc, [key, value]) => {
            const maskedValue = mask({ config: this.config, key, value });
            if (maskedValue != null) {
                acc[key] = maskedValue;
            }
            return acc;
        }, {});
        this.span.setAttributes(maskedAttributes);
        return this;
    }
    addEvent(name, attributesOrStartTime, startTime) {
        if (this.isEnded)
            return this;
        this.span.addEvent(name, attributesOrStartTime, startTime);
        return this;
    }
    setStatus(status) {
        if (this.isEnded)
            return this;
        this.span.setStatus(status);
        return this;
    }
    updateName(name) {
        if (this.isEnded)
            return this;
        this.span.updateName(name);
        return this;
    }
    end(endTime) {
        if (this.isEnded) {
            diag.warn(`FISpan.end called on already ended span ID: ${this.span.spanContext().spanId}`);
            return;
        }
        this.span.end(endTime);
        this.isEnded = true;
        // diag.debug(
        //     `FISpan.end CALLED for span ID: ${this.span.spanContext().spanId}`
        // );
    }
    isRecording() {
        return this.span.isRecording();
    }
    recordException(exception, time) {
        if (this.isEnded)
            return;
        this.span.recordException(exception, time);
    }
    spanContext() {
        return this.span.spanContext();
    }
    addLink(link) {
        if (this.isEnded)
            return this;
        this.span.addLink(link);
        return this;
    }
    addLinks(links) {
        if (this.isEnded)
            return this;
        this.span.addLinks(links);
        return this;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiRklTcGFuLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiRklTcGFuLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFTSCxJQUFJLEdBQ0wsTUFBTSxvQkFBb0IsQ0FBQztBQUU1QixPQUFPLEVBQUUsSUFBSSxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFFdEM7O0dBRUc7QUFDSCxNQUFNLE9BQU8sTUFBTTtJQUtqQixZQUFZLEVBQUUsSUFBSSxFQUFFLE1BQU0sRUFBdUM7UUFGekQsWUFBTyxHQUFZLEtBQUssQ0FBQztRQUcvQixJQUFJLENBQUMsSUFBSSxHQUFHLElBQUksQ0FBQztRQUNqQixJQUFJLENBQUMsTUFBTSxHQUFHLE1BQU0sQ0FBQztRQUNyQixNQUFNLGtCQUFrQixHQUFHLElBQUksQ0FBQyxXQUFXLEVBQUUsQ0FBQztRQUM5QyxNQUFNLE1BQU0sR0FBRyxrQkFBa0IsQ0FBQyxVQUFVLEtBQUssQ0FBQyxJQUFJLGtCQUFrQixDQUFDLE1BQU0sS0FBSyxrQkFBa0IsQ0FBQztRQUN2RyxjQUFjO1FBQ2Qsc0xBQXNMO1FBQ3RMLEtBQUs7SUFDUCxDQUFDO0lBRUQsWUFBWSxDQUFDLEdBQVcsRUFBRSxLQUFxQjtRQUM3QyxJQUFJLElBQUksQ0FBQyxPQUFPLEVBQUUsQ0FBQztZQUNqQixJQUFJLENBQUMsSUFBSSxDQUFDLGdEQUFnRCxJQUFJLENBQUMsSUFBSSxDQUFDLFdBQVcsRUFBRSxDQUFDLE1BQU0sYUFBYSxHQUFHLEVBQUUsQ0FBQyxDQUFDO1lBQzVHLE9BQU8sSUFBSSxDQUFDO1FBQ2QsQ0FBQztRQUNELE1BQU0sV0FBVyxHQUFHLElBQUksQ0FBQyxFQUFFLE1BQU0sRUFBRSxJQUFJLENBQUMsTUFBTSxFQUFFLEdBQUcsRUFBRSxLQUFLLEVBQUUsQ0FBQyxDQUFDO1FBQzlELElBQUksV0FBVyxJQUFJLElBQUksRUFBRSxDQUFDO1lBQ3hCLElBQUksQ0FBQyxJQUFJLENBQUMsWUFBWSxDQUFDLEdBQUcsRUFBRSxX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SUFBSSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDeEIsT0FBTyxJQUFJLENBQUM7SUFDZCxDQUFDO0lBRUQsUUFBUSxDQUFDLEtBQWE7UUFDcEIsSUFBSSxJQUFJLENBQUMsT0FBTztZQUFFLE9BQU8sSUFBSSxDQUFDO1FBQzlCLElBQUksQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLEtBQUssQ0FBQyxDQUFDO1FBQzFCLE9BQU8sSUFBSSxDQUFDO0lBQ2QsQ0FBQztDQUNGIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtcbiAgICBTcGFuLFxuICAgIFNwYW5Db250ZXh0LFxuICAgIFNwYW5TdGF0dXMsXG4gICAgVGltZUlucHV0LFxuICAgIEF0dHJpYnV0ZXMsXG4gICAgRXhjZXB0aW9uLFxuICAgIEF0dHJpYnV0ZVZhbHVlLFxuICAgIExpbmssXG4gICAgZGlhZyxcbiAgfSBmcm9tIFwiQG9wZW50ZWxlbWV0cnkvYXBpXCI7XG4gIGltcG9ydCB7IFRyYWNlQ29uZmlnIH0gZnJvbSBcIi4vdHlwZXNcIjtcbiAgaW1wb3J0IHsgbWFzayB9IGZyb20gXCIuL21hc2tpbmdSdWxlc1wiO1xuICBcbiAgLyoqXG4gICAqIEEgd3JhcHBlciBhcm91bmQgdGhlIE9wZW5UZWxlbWV0cnkge0BsaW5rIFNwYW59IGludGVyZmFjZSB0aGF0IG1hc2tzIHNlbnNpdGl2ZSBpbmZvcm1hdGlvbiBiYXNlZCBvbiB0aGUgcGFzc2VkIGluIHtAbGluayBUcmFjZUNvbmZpZ30uXG4gICAqL1xuICBleHBvcnQgY2xhc3MgRklTcGFuIGltcGxlbWVudHMgU3BhbiB7XG4gICAgcHJpdmF0ZSByZWFkb25seSBzcGFuOiBTcGFuO1xuICAgIHByaXZhdGUgcmVhZG9ubHkgY29uZmlnOiBUcmFjZUNvbmZpZztcbiAgICBwcml2YXRlIGlzRW5kZWQ6IGJvb2xlYW4gPSBmYWxzZTtcbiAgXG4gICAgY29uc3RydWN0b3IoeyBzcGFuLCBjb25maWcgfTogeyBzcGFuOiBTcGFuOyBjb25maWc6IFRyYWNlQ29uZmlnIH0pIHtcbiAgICAgIHRoaXMuc3BhbiA9IHNwYW47XG4gICAgICB0aGlzLmNvbmZpZyA9IGNvbmZpZztcbiAgICAgIGNvbnN0IHdyYXBwZWRTcGFuQ29udGV4dCA9IHNwYW4uc3BhbkNvbnRleHQoKTtcbiAgICAgIGNvbnN0IGlzTm9PcCA9IHdyYXBwZWRTcGFuQ29udGV4dC50cmFjZUZsYWdzID09PSAwICYmIHdyYXBwZWRTcGFuQ29udGV4dC5zcGFuSWQgPT09ICcwMDAwMDAwMDAwMDAwMDAwJztcbiAgICAgIC8vIGRpYWcuZGVidWcoXG4gICAgICAvLyAgICAgYEZJU3BhbiBDT05TVFJVQ1RPUjogV3JhcHBpbmcgc3Bhbi4gSUQ6ICR7d3JhcHBlZFNwYW5Db250ZXh0LnNwYW5JZH0sIFRyYWNlSUQ6ICR7d3JhcHBlZFNwYW5Db250ZXh0LnRyYWNlSWR9LCBUcmFjZUZsYWdzOiAke3dyYXBwZWRTcGFuQ29udGV4dC50cmFjZUZsYWdzfSwgSXMgTm9PcDogJHtpc05vT3B9YFxuICAgICAgLy8gKTtcbiAgICB9XG4gIFxuICAgIHNldEF0dHJpYnV0ZShrZXk6IHN0cmluZywgdmFsdWU6IEF0dHJpYnV0ZVZhbHVlKTogdGhpcyB7XG4gICAgICBpZiAodGhpcy5pc0VuZGVkKSB7XG4gICAgICAgIGRpYWcud2FybihgRklTcGFuLnNldEF0dHJpYnV0ZSBjYWxsZWQgb24gZW5kZWQgc3BhbiBJRDogJHt0aGlzLnNwYW4uc3BhbkNvbnRleHQoKS5zcGFuSWR9IGZvciBrZXk6ICR7a2V5fWApO1xuICAgICAgICByZXR1cm4gdGhpcztcbiAgICAgIH1cbiAgICAgIGNvbnN0IG1hc2tlZFZhbHVlID0gbWFzayh7IGNvbmZpZzogdGhpcy5jb25maWcsIGtleSwgdmFsdWUgfSk7XG4gICAgICBpZiAobWFza2VkVmFsdWUgIT0gbnVsbCkge1xuICAgICAgICB0aGlzLnNwYW4uc2V0QXR0cmlidXRlKGtleSwgbWFza2VkVmFsdWUpO1xuICAgICAgfVxuICAgICAgcmV0dXJuIHRoaXM7XG4gICAgfVxuICBcbiAgICBzZXRBdHRyaWJ1dGVzKGF0dHJpYnV0ZXM6IEF0dHJpYnV0ZXMpOiB0aGlzIHtcbiAgICAgIGlmICh0aGlzLmlzRW5kZWQpIHtcbiAgICAgICAgZGlhZy53YXJuKGBGSVNwYW4uc2V0QXR0cmlidXRlcyBjYWxsZWQgb24gZW5kZWQgc3BhbiBJRDogJHt0aGlzLnNwYW4uc3BhbkNvbnRleHQoKS5zcGFuSWR9YCk7XG4gICAgICAgIHJldHVybiB0aGlzO1xuICAgICAgfVxuICAgICAgY29uc3QgbWFza2VkQXR0cmlidXRlcyA9IE9iamVjdC5lbnRyaWVzKGF0dHJpYnV0ZXMpLnJlZHVjZShcbiAgICAgICAgKGFjYywgW2tleSwgdmFsdWVdKSA9PiB7XG4gICAgICAgICAgY29uc3QgbWFza2VkVmFsdWUgPSBtYXNrKHsgY29uZmlnOiB0aGlzLmNvbmZpZywga2V5LCB2YWx1ZSB9KTtcbiAgICAgICAgICBpZiAobWFza2VkVmFsdWUgIT0gbnVsbCkge1xuICAgICAgICAgICAgYWNjW2tleV0gPSBtYXNrZWRWYWx1ZTtcbiAgICAgICAgICB9XG4gICAgICAgICAgcmV0dXJuIGFjYztcbiAgICAgICAgfSxcbiAgICAgICAge30gYXMgQXR0cmlidXRlcyxcbiAgICAgICk7XG4gICAgICB0aGlzLnNwYW4uc2V0QXR0cmlidXRlcyhtYXNrZWRBdHRyaWJ1dGVzKTtcbiAgICAgIHJldHVybiB0aGlzO1xuICAgIH1cbiAgXG4gICAgYWRkRXZlbnQoXG4gICAgICBuYW1lOiBzdHJpbmcsXG4gICAgICBhdHRyaWJ1dGVzT3JTdGFydFRpbWU/OiBBdHRyaWJ1dGVzIHwgVGltZUlucHV0LFxuICAgICAgc3RhcnRUaW1lPzogVGltZUlucHV0LFxuICAgICk6IHRoaXMge1xuICAgICAgaWYgKHRoaXMuaXNFbmRlZCkgcmV0dXJuIHRoaXM7XG4gICAgICB0aGlzLnNwYW4uYWRkRXZlbnQobmFtZSwgYXR0cmlidXRlc09yU3RhcnRUaW1lLCBzdGFydFRpbWUpO1xuICAgICAgcmV0dXJuIHRoaXM7XG4gICAgfVxuICBcbiAgICBzZXRTdGF0dXMoc3RhdHVzOiBTcGFuU3RhdHVzKTogdGhpcyB7XG4gICAgICBpZiAodGhpcy5pc0VuZGVkKSByZXR1cm4gdGhpcztcbiAgICAgIHRoaXMuc3Bhbi5zZXRTdGF0dXMoc3RhdHVzKTtcbiAgICAgIHJldHVybiB0aGlzO1xuICAgIH1cbiAgXG4gICAgdXBkYXRlTmFtZShuYW1lOiBzdHJpbmcpOiB0aGlzIHtcbiAgICAgIGlmICh0aGlzLmlzRW5kZWQpIHJldHVybiB0aGlzO1xuICAgICAgdGhpcy5zcGFuLnVwZGF0ZU5hbWUobmFtZSk7XG4gICAgICByZXR1cm4gdGhpcztcbiAgICB9XG4gIFxuICAgIGVuZChlbmRUaW1lPzogVGltZUlucHV0KTogdm9pZCB7XG4gICAgICBpZiAodGhpcy5pc0VuZGVkKSB7XG4gICAgICAgIGRpYWcud2FybihgRklTcGFuLmVuZCBjYWxsZWQgb24gYWxyZWFkeSBlbmRlZCBzcGFuIElEOiAke3RoaXMuc3Bhbi5zcGFuQ29udGV4dCgpLnNwYW5JZH1gKTtcbiAgICAgICAgcmV0dXJuO1xuICAgICAgfVxuICAgICAgdGhpcy5zcGFuLmVuZChlbmRUaW1lKTtcbiAgICAgIHRoaXMuaXNFbmRlZCA9IHRydWU7XG4gICAgICAvLyBkaWFnLmRlYnVnKFxuICAgICAgLy8gICAgIGBGSVNwYW4uZW5kIENBTExFRCBmb3Igc3BhbiBJRDogJHt0aGlzLnNwYW4uc3BhbkNvbnRleHQoKS5zcGFuSWR9YFxuICAgICAgLy8gKTtcbiAgICB9XG4gIFxuICAgIGlzUmVjb3JkaW5nKCk6IGJvb2xlYW4ge1xuICAgICAgcmV0dXJuIHRoaXMuc3Bhbi5pc1JlY29yZGluZygpO1xuICAgIH1cbiAgXG4gICAgcmVjb3JkRXhjZXB0aW9uKGV4Y2VwdGlvbjogRXhjZXB0aW9uLCB0aW1lPzogVGltZUlucHV0KTogdm9pZCB7XG4gICAgICBpZiAodGhpcy5pc0VuZGVkKSByZXR1cm47XG4gICAgICB0aGlzLnNwYW4ucmVjb3JkRXhjZXB0aW9uKGV4Y2VwdGlvbiwgdGltZSk7XG4gICAgfVxuICBcbiAgICBzcGFuQ29udGV4dCgpOiBTcGFuQ29udGV4dCB7XG4gICAgICByZXR1cm4gdGhpcy5zcGFuLnNwYW5Db250ZXh0KCk7XG4gICAgfVxuICBcbiAgICBhZGRMaW5rKGxpbms6IExpbmspOiB0aGlzIHtcbiAgICAgIGlmICh0aGlzLmlzRW5kZWQpIHJldHVybiB0aGlzO1xuICAgICAgdGhpcy5zcGFuLmFkZExpbmsobGluayk7XG4gICAgICByZXR1cm4gdGhpcztcbiAgICB9XG4gIFxuICAgIGFkZExpbmtzKGxpbmtzOiBMaW5rW10pOiB0aGlzIHtcbiAgICAgIGlmICh0aGlzLmlzRW5kZWQpIHJldHVybiB0aGlzO1xuICAgICAgdGhpcy5zcGFuLmFkZExpbmtzKGxpbmtzKTtcbiAgICAgIHJldHVybiB0aGlzO1xuICAgIH1cbiAgfSJdfQ==