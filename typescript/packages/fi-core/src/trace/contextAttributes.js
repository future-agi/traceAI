import { METADATA, PROMPT_TEMPLATE_TEMPLATE, PROMPT_TEMPLATE_VARIABLES, PROMPT_TEMPLATE_VERSION, SESSION_ID, TAG_TAGS, USER_ID, } from "@traceai/fi-semantic-conventions";
import { createContextKey } from "@opentelemetry/api";
import { safelyJSONStringify, safelyJSONParse, isStringArray, isObjectWithStringKeys, isAttributes, } from "../utils";
import { isAttributeValue } from "@opentelemetry/core";
const CONTEXT_ATTRIBUTES_ATTRIBUTES_KEY = "attributes";
export const ContextAttributes = {
    [PROMPT_TEMPLATE_TEMPLATE]: createContextKey(`FI SDK Context Key ${PROMPT_TEMPLATE_TEMPLATE}`),
    [PROMPT_TEMPLATE_VARIABLES]: createContextKey(`FI SDK Context Key ${PROMPT_TEMPLATE_VARIABLES}`),
    [PROMPT_TEMPLATE_VERSION]: createContextKey(`FI SDK Context Key ${PROMPT_TEMPLATE_VERSION}`),
    [SESSION_ID]: createContextKey(`FI SDK Context Key ${SESSION_ID}`),
    [METADATA]: createContextKey(`FI SDK Context Key ${METADATA}`),
    [USER_ID]: createContextKey(`FI SDK Context Key ${USER_ID}`),
    [TAG_TAGS]: createContextKey(`FI SDK Context Key ${TAG_TAGS}`),
    [CONTEXT_ATTRIBUTES_ATTRIBUTES_KEY]: createContextKey(`FI SDK Context Key attributes`),
};
const { [PROMPT_TEMPLATE_TEMPLATE]: PROMPT_TEMPLATE_TEMPLATE_KEY, [PROMPT_TEMPLATE_VARIABLES]: PROMPT_TEMPLATE_VARIABLES_KEY, [PROMPT_TEMPLATE_VERSION]: PROMPT_TEMPLATE_VERSION_KEY, [SESSION_ID]: SESSION_ID_KEY, [METADATA]: METADATA_KEY, [USER_ID]: USER_ID_KEY, [TAG_TAGS]: TAG_TAGS_KEY, [CONTEXT_ATTRIBUTES_ATTRIBUTES_KEY]: ATTRIBUTES_KEY, } = ContextAttributes;
export function setPromptTemplate(context, attributes) {
    const { template, variables, version } = attributes;
    context = context.setValue(PROMPT_TEMPLATE_TEMPLATE_KEY, template);
    if (variables) {
        context = context.setValue(PROMPT_TEMPLATE_VARIABLES_KEY, safelyJSONStringify(variables));
    }
    if (version) {
        context = context.setValue(PROMPT_TEMPLATE_VERSION_KEY, version);
    }
    return context;
}
export function clearPromptTemplate(context) {
    context = context.deleteValue(PROMPT_TEMPLATE_TEMPLATE_KEY);
    context = context.deleteValue(PROMPT_TEMPLATE_VARIABLES_KEY);
    context = context.deleteValue(PROMPT_TEMPLATE_VERSION_KEY);
    return context;
}
export function getPromptTemplate(context) {
    const maybeTemplate = context.getValue(PROMPT_TEMPLATE_TEMPLATE_KEY);
    const maybeVariables = context.getValue(PROMPT_TEMPLATE_VARIABLES_KEY);
    const maybeVersion = context.getValue(PROMPT_TEMPLATE_VERSION_KEY);
    const attributes = {};
    if (typeof maybeTemplate === "string") {
        attributes.template = maybeTemplate;
    }
    if (typeof maybeVariables === "string") {
        const parsedVariables = safelyJSONParse(maybeVariables);
        attributes.variables = isObjectWithStringKeys(parsedVariables)
            ? parsedVariables
            : undefined;
    }
    if (typeof maybeVersion === "string") {
        attributes.version = maybeVersion;
    }
    if (Object.keys(attributes).length === 0) {
        return;
    }
    return attributes;
}
export function setSession(context, attributes) {
    const { sessionId } = attributes;
    return context.setValue(SESSION_ID_KEY, sessionId);
}
export function clearSession(context) {
    return context.deleteValue(SESSION_ID_KEY);
}
/**
 * Retrieves the session ID from the given context.
 * @param context - The context object.
 * @returns {string | undefined} The session ID if it exists, otherwise undefined.
 */
export function getSession(context) {
    const maybeSessionId = context.getValue(SESSION_ID_KEY);
    if (typeof maybeSessionId === "string") {
        return { sessionId: maybeSessionId };
    }
}
export function setMetadata(context, attributes) {
    return context.setValue(METADATA_KEY, safelyJSONStringify(attributes));
}
export function clearMetadata(context) {
    return context.deleteValue(METADATA_KEY);
}
export function getMetadata(context) {
    const maybeMetadata = context.getValue(METADATA_KEY);
    if (typeof maybeMetadata === "string") {
        const parsedMetadata = safelyJSONParse(maybeMetadata);
        return isObjectWithStringKeys(parsedMetadata) ? parsedMetadata : undefined;
    }
}
export function setUser(context, attributes) {
    const { userId } = attributes;
    return context.setValue(USER_ID_KEY, userId);
}
export function clearUser(context) {
    return context.deleteValue(USER_ID_KEY);
}
export function getUser(context) {
    const maybeUserId = context.getValue(USER_ID_KEY);
    if (typeof maybeUserId === "string") {
        return { userId: maybeUserId };
    }
}
export function setTags(context, attributes) {
    return context.setValue(TAG_TAGS_KEY, safelyJSONStringify(attributes));
}
export function clearTags(context) {
    return context.deleteValue(TAG_TAGS_KEY);
}
export function getTags(context) {
    const maybeTags = context.getValue(TAG_TAGS_KEY);
    if (typeof maybeTags === "string") {
        const parsedTags = safelyJSONParse(maybeTags);
        return isStringArray(parsedTags) ? parsedTags : undefined;
    }
}
export function setAttributes(context, attributes) {
    return context.setValue(ATTRIBUTES_KEY, safelyJSONStringify(attributes));
}
export function clearAttributes(context) {
    return context.deleteValue(ATTRIBUTES_KEY);
}
export function getAttributes(context) {
    const maybeAttributes = context.getValue(ATTRIBUTES_KEY);
    if (typeof maybeAttributes === "string") {
        const parsedAttributes = safelyJSONParse(maybeAttributes);
        return isAttributes(parsedAttributes) ? parsedAttributes : undefined;
    }
}
/**
 * Gets the FI attributes from the given context
 * @param context
 * @example span.setAttributes(getAttributesFromContext(context.active()));
 * @returns {Attributes} The FI attributes formatted as OpenTelemetry span attributes.
 */
export function getAttributesFromContext(context) {
    let attributes = {};
    Object.entries(ContextAttributes).forEach(([key, symbol]) => {
        const maybeValue = context.getValue(symbol);
        if (key === CONTEXT_ATTRIBUTES_ATTRIBUTES_KEY) {
            if (typeof maybeValue === "string") {
                const parsedAttributes = safelyJSONParse(maybeValue);
                if (isAttributes(parsedAttributes)) {
                    attributes = { ...attributes, ...parsedAttributes };
                }
            }
            return;
        }
        if (isAttributeValue(maybeValue) && maybeValue !== undefined) {
            attributes[key] = maybeValue;
        }
    });
    return attributes;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29udGV4dEF0dHJpYnV0ZXMuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJjb250ZXh0QXR0cmlidXRlcy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQ0gsUUFBUSxFQUNSLHdCQUF3QixFQUN4Qix5QkFBeUIsRUFDekIsdUJBQXVCLEVBQ3ZCLFVBQVUsRUFDVixRQUFRLEVBQ1IsT0FBTyxHQUNSLE1BQU0sa0NBQWtDLENBQUM7QUFDMUMsT0FBTyxFQUF1QixnQkFBZ0IsRUFBRSxNQUFNLG9CQUFvQixDQUFDO0FBQzNFLE9BQU8sRUFDTCxtQkFBbUIsRUFDbkIsZUFBZSxFQUNmLGFBQWEsRUFDYixzQkFBc0IsRUFDdEIsWUFBWSxHQUNiLE1BQU0sVUFBVSxDQUFDO0FBRWxCLE9BQU8sRUFBRSxnQkFBZ0IsRUFBRSxNQUFNLHFCQUFxQixDQUFDO0FBRXZELE1BQU0saUNBQWlDLEdBQUcsWUFBcUIsQ0FBQztBQUVoRSxNQUFNLENBQUMsTUFBTSxpQkFBaUIsR0FBRztJQUMvQixDQUFDLHdCQUF3QixDQUFDLEVBQUUsZ0JBQWdCLENBQzFDLHNCQUFzQix3QkFBd0IsRUFBRSxDQUNqRDtJQUNELENBQUMseUJBQXlCLENBQUMsRUFBRSxnQkFBZ0IsQ0FDM0Msc0JBQXNCLHlCQUF5QixFQUFFLENBQ2xEO0lBQ0QsQ0FBQyx1QkFBdUIsQ0FBQyxFQUFFLGdCQUFnQixDQUN6QyxzQkFBc0IsdUJBQXVCLEVBQUUsQ0FDaEQ7SUFDRCxDQUFDLFVBQVUsQ0FBQyxFQUFFLGdCQUFnQixDQUFDLHNCQUFzQixVQUFVLEVBQUUsQ0FBQztJQUNsRSxDQUFDLFFBQVEsQ0FBQyxFQUFFLGdCQUFnQixDQUFDLHNCQUFzQixRQUFRLEVBQUUsQ0FBQztJQUM5RCxDQUFDLE9BQU8sQ0FBQyxFQUFFLGdCQUFnQixDQUFDLHNCQUFzQixPQUFPLEVBQUUsQ0FBQztJQUM1RCxDQUFDLFFBQVEsQ0FBQyxFQUFFLGdCQUFnQixDQUFDLHNCQUFzQixRQUFRLEVB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VSxFQUFFLEdBQUcsZ0JBQWdCLEVBQUUsQ0FBQztnQkFDdEQsQ0FBQztZQUNILENBQUM7WUFDRCxPQUFPO1FBQ1QsQ0FBQztRQUVELElBQUksZ0JBQWdCLENBQUMsVUFBVSxDQUFDLElBQUksVUFBVSxLQUFLLFNBQVMsRUFBRSxDQUFDO1lBQzdELFVBQVUsQ0FBQyxHQUFHLENBQUMsR0FBRyxVQUFVLENBQUM7UUFDL0IsQ0FBQztJQUNILENBQUMsQ0FBQyxDQUFDO0lBQ0gsT0FBTyxVQUFVLENBQUM7QUFDcEIsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7XG4gICAgTUVUQURBVEEsXG4gICAgUFJPTVBUX1RFTVBMQVRFX1RFTVBMQVRFLFxuICAgIFBST01QVF9URU1QTEFURV9WQVJJQUJMRVMsXG4gICAgUFJPTVBUX1RFTVBMQVRFX1ZFUlNJT04sXG4gICAgU0VTU0lPTl9JRCxcbiAgICBUQUdfVEFHUyxcbiAgICBVU0VSX0lELFxuICB9IGZyb20gXCJAdHJhY2VhaS9maS1zZW1hbnRpYy1jb252ZW50aW9uc1wiO1xuICBpbXBvcnQgeyBBdHRyaWJ1dGVzLCBDb250ZXh0LCBjcmVhdGVDb250ZXh0S2V5IH0gZnJvbSBcIkBvcGVudGVsZW1ldHJ5L2FwaVwiO1xuICBpbXBvcnQge1xuICAgIHNhZmVseUpTT05TdHJpbmdpZnksXG4gICAgc2FmZWx5SlNPTlBhcnNlLFxuICAgIGlzU3RyaW5nQXJyYXksXG4gICAgaXNPYmplY3RXaXRoU3RyaW5nS2V5cyxcbiAgICBpc0F0dHJpYnV0ZXMsXG4gIH0gZnJvbSBcIi4uL3V0aWxzXCI7XG4gIGltcG9ydCB7IE1ldGFkYXRhLCBQcm9tcHRUZW1wbGF0ZSwgU2Vzc2lvbiwgVGFncywgVXNlciB9IGZyb20gXCIuL3R5cGVzXCI7XG4gIGltcG9ydCB7IGlzQXR0cmlidXRlVmFsdWUgfSBmcm9tIFwiQG9wZW50ZWxlbWV0cnkvY29yZVwiO1xuICBcbiAgY29uc3QgQ09OVEVYVF9BVFRSSUJVVEVTX0FUVFJJQlVURVNfS0VZID0gXCJhdHRyaWJ1dGVzXCIgYXMgY29uc3Q7XG4gIFxuICBleHBvcnQgY29uc3QgQ29udGV4dEF0dHJpYnV0ZXMgPSB7XG4gICAgW1BST01QVF9URU1QTEFURV9URU1QTEFURV06IGNyZWF0ZUNvbnRleHRLZXkoXG4gICAgICBgRkkgU0RLIENvbnRleHQgS2V5ICR7UFJPTVBUX1RFTVBMQVRFX1RFTVBMQVRFfWAsXG4gICAgKSxcbiAgICBbUFJPTVBUX1RFTVBMQVRFX1ZBUklBQkxFU106IGNyZWF0ZUNvbnRleHRLZXkoXG4gICAgICBgRkkgU0RLIENvbnRleHQgS2V5ICR7UFJPTVBUX1RFTVBMQVRFX1ZBUklBQkxFU31gLFxuICAgICksXG4gICAgW1BST01QVF9URU1QTEFURV9WRVJTSU9OXTogY3JlYXRlQ29udGV4dEtleShcbiAgICAgIGBGSSBTREsgQ29udGV4dCBLZXkgJHtQUk9NUFRfVEVNUExBVEVfVkVSU0lPTn1gLFxuICAgICksXG4gICAgW1NFU1NJT05fSURdOiBjcmVhdGVDb250ZXh0S2V5KGBGSSBTREsgQ29udGV4dCBLZXkgJHtTRVNTSU9OX0lEfWApLFxuICAgIFtNRVRBREFUQV06IGNyZWF0ZUNvbnRleHRLZXkoYEZJIFNESyBDb250ZXh0IEtleSAke01FVEFEQVRBfWApLFxuICAgIFtVU0VSX0lEXTogY3JlYXRlQ29udGV4dEtleShgRkkgU0RLIENvbnRleHQgS2V5ICR7VVNFUl9JRH1gKSxcbiAgICBbVEFHX1RBR1NdOiBjcmVhdGVDb250ZXh0S2V5KGBGSSBTREsgQ29udGV4dCBLZXkgJHtUQUdfVEFHU31gKSxcbiAgICBbQ09OVEVYVF9BVFRSSUJVVEVTX0FUVFJJQlVURVNfS0VZXTogY3JlYXRlQ29udGV4dEtleShcbiAgICAgIGBGSSBTREsgQ29udGV4dCBLZXkgYXR0cmlidXRlc2AsXG4gICAgKSxcbiAgfSBhcyBjb25zdDtcbiAgXG4gIGNvbnN0IHtcbiAgICBbUFJPTVBUX1RFTVBMQVRFX1RFTVBMQVRFXTogUFJPTVBUX1RFTVBMQVRFX1RFTVBMQVRFX0tFWSxcbiAgICBbUFJPTVBUX1RFTVBMQVRFX1ZBUklBQkxFU106IFBST01QVF9URU1QTEFURV9WQVJJQUJMRVNfS0VZLFxuICAgIFtQUk9NUFRfVEVNUExBVEVfVkVSU0lPTl06IFBST01QVF9URU1QTEFURV9WRVJTSU9OX0tFWSxcbiAgICBbU0VTU0lPTl9JRF06IFNFU1NJT05fSURfS0VZLFxuICAgIFtNRVRBREFUQV06IE1FVEFEQVRBX0tFWSxcbiAgICBbVVNFUl9JRF06IFVTRVJfSURfS0VZLFxuICAgIFtUQUdfVEFHU106IFRBR19UQUdTX0tFWSxcbiAgICBbQ09OVEVYVF9BVFRSSUJVVEVTX0FUVFJJQlVURVNfS0VZXTogQVRUUklCVVRFU19LRVksXG4gIH0gPSBDb250ZXh0QXR0cmlidXRlcztcbiAgXG4gIGV4cG9ydCBmdW5jdGlvbiBzZXRQcm9tcHRUZW1wbGF0ZShcbiAgICBjb250ZXh0OiBDb250ZXh0LFxuICAgIGF0dHJpYnV0ZXM6IFByb21wdFRlbXBsYXRlLFxuICApOiBDb250ZXh0IHtcbiAgICBjb25zdCB7IHRlbXBsYXRlLCB2YXJpYWJsZXMsIHZlcnNpb24gfSA9IGF0dHJpYnV0ZXM7XG4gICAgY29udGV4dCA9IGNvbnRleHQuc2V0VmFsdWUoUFJPTVBUX1RFTVBMQVRFX1RFTVBMQVRFX0tFWSwgdGVtcGxhdGUpO1xuICAgIGlmICh2YXJpYWJsZXMpIHtcbiAgICAgIGNvbnRleHQgPSBjb250ZXh0LnNldFZhbHVlKFxuICAgICAgICBQUk9NUFRfVEVNUExBVEVfVkFSSUFCTEVTX0tFWSxcbiAgICAgICAgc2FmZWx5SlNPTlN0cmluZ2lmeSh2YXJpYWJsZXMpLFxuICAgICAgKTtcbiAgICB9XG4gICAgaWYgKHZlcnNpb24pIHtcbiAgICAgIGNvbnRleHQgPSBjb250ZXh0LnNldFZhbHVlKFBST01QVF9URU1QTEFURV9WRVJTSU9OX0tFWSwgdmVyc2lvbik7XG4gICAgfVxuICAgIHJldHVybiBjb250ZXh0O1xuICB9XG4gIFxuICBleHBvcnQgZnVuY3Rpb24gY2xlYXJQcm9tcHRUZW1wbGF0ZShjb250ZXh0OiBDb250ZXh0KTogQ29udGV4dCB7XG4gICAgY29udGV4dCA9IGNvbnRleHQuZGVsZXRlVmFsdWUoUFJPTVBUX1RFTVBMQVRFX1RFTVBMQVRFX0tFWSk7XG4gICAgY29udGV4dCA9IGNvbnRleHQuZGVsZXRlVmFsdWUoUFJPTVBUX1RFTVBMQVRFX1ZBUklBQkxFU19LRVkpO1xuICAgIGNvbnRleHQgPSBjb250ZXh0LmRlbGV0ZVZhbHVlKFBST01QVF9URU1QTEFURV9WRVJTSU9OX0tFWSk7XG4gICAgcmV0dXJuIGNvbnRleHQ7XG4gIH1cbiAgXG4gIGV4cG9ydCBmdW5jdGlvbiBnZXRQcm9tcHRUZW1wbGF0ZShcbiAgICBjb250ZXh0OiBDb250ZXh0LFxuICApOiBQYXJ0aWFsPFByb21wdFRlbXBsYXRlPiB8IHVuZGVmaW5lZCB7XG4gICAgY29uc3QgbWF5YmVUZW1wbGF0ZSA9IGNvbnRleHQuZ2V0VmFsdWUoUFJPTVBUX1RFTVBMQVRFX1RFTVBMQVRFX0tFWSk7XG4gICAgY29uc3QgbWF5YmVWYXJpYWJsZXMgPSBjb250ZXh0LmdldFZhbHVlKFBST01QVF9URU1QTEFURV9WQVJJQUJMRVNfS0VZKTtcbiAgICBjb25zdCBtYXliZVZlcnNpb24gPSBjb250ZXh0LmdldFZhbHVlKFBST01QVF9URU1QTEFURV9WRVJTSU9OX0tFWSk7XG4gICAgY29uc3QgYXR0cmlidXRlczogUGFydGlhbDxQcm9tcHRUZW1wbGF0ZT4gPSB7fTtcbiAgXG4gICAgaWYgKHR5cGVvZiBtYXliZVRlbXBsYXRlID09PSBcInN0cmluZ1wiKSB7XG4gICAgICBhdHRyaWJ1dGVzLnRlbXBsYXRlID0gbWF5YmVUZW1wbGF0ZTtcbiAgICB9XG4gICAgaWYgKHR5cGVvZiBtYXliZVZhcmlhYmxlcyA9PT0gXCJzdHJpbmdcIikge1xuICAgICAgY29uc3QgcGFyc2VkVmFyaWFibGVzID0gc2FmZWx5SlNPTlBhcnNlKG1heWJlVmFyaWFibGVzKTtcbiAgICAgIGF0dHJpYnV0ZXMudmFyaWFibGVzID0gaXNPYmplY3RXaXRoU3RyaW5nS2V5cyhwYXJzZWRWYXJpYWJsZXMpXG4gICAgICAgID8gcGFyc2VkVmFyaWFibGVzXG4gICAgICAgIDogdW5kZWZpbmVkO1xuICAgIH1cbiAgICBpZiAodHlwZW9mIG1heWJlVmVyc2lvbiA9PT0gXCJzdHJpbmdcIikge1xuICAgICAgYXR0cmlidXRlcy52ZXJzaW9uID0gbWF5YmVWZXJzaW9uO1xuICAgIH1cbiAgXG4gICAgaWYgKE9iamVjdC5rZXlzKGF0dHJpYnV0ZXMpLmxlbmd0aCA9PT0gMCkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgXG4gICAgcmV0dXJuIGF0dHJpYnV0ZXM7XG4gIH1cbiAgXG4gIGV4cG9ydCBmdW5jdGlvbiBzZXRTZXNzaW9uKGNvbnRleHQ6IENvbnRleHQsIGF0dHJpYnV0ZXM6IFNlc3Npb24pOiBDb250ZXh0IHtcbiAgICBjb25zdCB7IHNlc3Npb25JZCB9ID0gYXR0cmlidXRlcztcbiAgICByZXR1cm4gY29udGV4dC5zZXRWYWx1ZShTRVNTSU9OX0lEX0tFWSwgc2Vzc2lvbklkKTtcbiAgfVxuICBcbiAgZXhwb3J0IGZ1bmN0aW9uIGNsZWFyU2Vzc2lvbihjb250ZXh0OiBDb250ZXh0KTogQ29udGV4dCB7XG4gICAgcmV0dXJuIGNvbnRleHQuZGVsZXRlVmFsdWUoU0VTU0lPTl9JRF9LRVkpO1xuICB9XG4gIFxuICAvKipcbiAgICogUmV0cmlldmVzIHRoZSBzZXNzaW9uIElEIGZyb20gdGhlIGdpdmVuIGNvbnRleHQuXG4gICAqIEBwYXJhbSBjb250ZXh0IC0gVGhlIGNvbnRleHQgb2JqZWN0LlxuICAgKiBAcmV0dXJucyB7c3RyaW5nIHwgdW5kZWZpbmVkfSBUaGUgc2Vzc2lvbiBJRCBpZiBpdCBleGlzdHMsIG90aGVyd2lzZSB1bmRlZmluZWQuXG4gICAqL1xuICBleHBvcnQgZnVuY3Rpb24gZ2V0U2Vzc2lvbihjb250ZXh0OiBDb250ZXh0KTogU2Vzc2lvbiB8IHVuZGVmaW5lZCB7XG4gICAgY29uc3QgbWF5YmVTZXNzaW9uSWQgPSBjb250ZXh0LmdldFZhbHVlKFNFU1NJT05fSURfS0VZKTtcbiAgICBpZiAodHlwZW9mIG1heWJlU2Vzc2lvbklkID09PSBcInN0cmluZ1wiKSB7XG4gICAgICByZXR1cm4geyBzZXNzaW9uSWQ6IG1heWJlU2Vzc2lvbklkIH07XG4gICAgfVxuICB9XG4gIFxuICBleHBvcnQgZnVuY3Rpb24gc2V0TWV0YWRhdGEoY29udGV4dDogQ29udGV4dCwgYXR0cmlidXRlczogTWV0YWRhdGEpOiBDb250ZXh0IHtcbiAgICByZXR1cm4gY29udGV4dC5zZXRWYWx1ZShNRVRBREFUQV9LRVksIHNhZmVseUpTT05TdHJpbmdpZnkoYXR0cmlidXRlcykpO1xuICB9XG4gIFxuICBleHBvcnQgZnVuY3Rpb24gY2xlYXJNZXRhZGF0YShjb250ZXh0OiBDb250ZXh0KTogQ29udGV4dCB7XG4gICAgcmV0dXJuIGNvbnRleHQuZGVsZXRlVmFsdWUoTUVUQURBVEFfS0VZKTtcbiAgfVxuICBcbiAgZXhwb3J0IGZ1bmN0aW9uIGdldE1ldGFkYXRhKGNvbnRleHQ6IENvbnRleHQpOiBNZXRhZGF0YSB8IHVuZGVmaW5lZCB7XG4gICAgY29uc3QgbWF5YmVNZXRhZGF0YSA9IGNvbnRleHQuZ2V0VmFsdWUoTUVUQURBVEFfS0VZKTtcbiAgXG4gICAgaWYgKHR5cGVvZiBtYXliZU1ldGFkYXRhID09PSBcInN0cmluZ1wiKSB7XG4gICAgICBjb25zdCBwYXJzZWRNZXRhZGF0YSA9IHNhZmVseUpTT05QYXJzZShtYXliZU1ldGFkYXRhKTtcbiAgICAgIHJldHVybiBpc09iamVjdFdpdGhTdHJpbmdLZXlzKHBhcnNlZE1ldGFkYXRhKSA/IHBhcnNlZE1ldGFkYXRhIDogdW5kZWZpbmVkO1xuICAgIH1cbiAgfVxuICBcbiAgZXhwb3J0IGZ1bmN0aW9uIHNldFVzZXIoY29udGV4dDogQ29udGV4dCwgYXR0cmlidXRlczogVXNlcik6IENvbnRleHQge1xuICAgIGNvbnN0IHsgdXNlcklkIH0gPSBhdHRyaWJ1dGVzO1xuICAgIHJldHVybiBjb250ZXh0LnNldFZhbHVlKFVTRVJfSURfS0VZLCB1c2VySWQpO1xuICB9XG4gIFxuICBleHBvcnQgZnVuY3Rpb24gY2xlYXJVc2VyKGNvbnRleHQ6IENvbnRleHQpOiBDb250ZXh0IHtcbiAgICByZXR1cm4gY29udGV4dC5kZWxldGVWYWx1ZShVU0VSX0lEX0tFWSk7XG4gIH1cbiAgXG4gIGV4cG9ydCBmdW5jdGlvbiBnZXRVc2VyKGNvbnRleHQ6IENvbnRleHQpOiBVc2VyIHwgdW5kZWZpbmVkIHtcbiAgICBjb25zdCBtYXliZVVzZXJJZCA9IGNvbnRleHQuZ2V0VmFsdWUoVVNFUl9JRF9LRVkpO1xuICAgIGlmICh0eXBlb2YgbWF5YmVVc2VySWQgPT09IFwic3RyaW5nXCIpIHtcbiAgICAgIHJldHVybiB7IHVzZXJJZDogbWF5YmVVc2VySWQgfTtcbiAgICB9XG4gIH1cbiAgXG4gIGV4cG9ydCBmdW5jdGlvbiBzZXRUYWdzKGNvbnRleHQ6IENvbnRleHQsIGF0dHJpYnV0ZXM6IFRhZ3MpOiBDb250ZXh0IHtcbiAgICByZXR1cm4gY29udGV4dC5zZXRWYWx1ZShUQUdfVEFHU19LRVksIHNhZmVseUpTT05TdHJpbmdpZnkoYXR0cmlidXRlcykpO1xuICB9XG4gIFxuICBleHBvcnQgZnVuY3Rpb24gY2xlYXJUYWdzKGNvbnRleHQ6IENvbnRleHQpOiBDb250ZXh0IHtcbiAgICByZXR1cm4gY29udGV4dC5kZWxldGVWYWx1ZShUQUdfVEFHU19LRVkpO1xuICB9XG4gIFxuICBleHBvcnQgZnVuY3Rpb24gZ2V0VGFncyhjb250ZXh0OiBDb250ZXh0KTogVGFncyB8IHVuZGVmaW5lZCB7XG4gICAgY29uc3QgbWF5YmVUYWdzID0gY29udGV4dC5nZXRWYWx1ZShUQUdfVEFHU19LRVkpO1xuICAgIGlmICh0eXBlb2YgbWF5YmVUYWdzID09PSBcInN0cmluZ1wiKSB7XG4gICAgICBjb25zdCBwYXJzZWRUYWdzID0gc2FmZWx5SlNPTlBhcnNlKG1heWJlVGFncyk7XG4gICAgICByZXR1cm4gaXNTdHJpbmdBcnJheShwYXJzZWRUYWdzKSA/IHBhcnNlZFRhZ3MgOiB1bmRlZmluZWQ7XG4gICAgfVxuICB9XG4gIFxuICBleHBvcnQgZnVuY3Rpb24gc2V0QXR0cmlidXRlcyhcbiAgICBjb250ZXh0OiBDb250ZXh0LFxuICAgIGF0dHJpYnV0ZXM6IEF0dHJpYnV0ZXMsXG4gICk6IENvbnRleHQge1xuICAgIHJldHVybiBjb250ZXh0LnNldFZhbHVlKEFUVFJJQlVURVNfS0VZLCBzYWZlbHlKU09OU3RyaW5naWZ5KGF0dHJpYnV0ZXMpKTtcbiAgfVxuICBcbiAgZXhwb3J0IGZ1bmN0aW9uIGNsZWFyQXR0cmlidXRlcyhjb250ZXh0OiBDb250ZXh0KTogQ29udGV4dCB7XG4gICAgcmV0dXJuIGNvbnRleHQuZGVsZXRlVmFsdWUoQVRUUklCVVRFU19LRVkpO1xuICB9XG4gIFxuICBleHBvcnQgZnVuY3Rpb24gZ2V0QXR0cmlidXRlcyhjb250ZXh0OiBDb250ZXh0KTogQXR0cmlidXRlcyB8IHVuZGVmaW5lZCB7XG4gICAgY29uc3QgbWF5YmVBdHRyaWJ1dGVzID0gY29udGV4dC5nZXRWYWx1ZShBVFRSSUJVVEVTX0tFWSk7XG4gICAgaWYgKHR5cGVvZiBtYXliZUF0dHJpYnV0ZXMgPT09IFwic3RyaW5nXCIpIHtcbiAgICAgIGNvbnN0IHBhcnNlZEF0dHJpYnV0ZXMgPSBzYWZlbHlKU09OUGFyc2UobWF5YmVBdHRyaWJ1dGVzKTtcbiAgICAgIHJldHVybiBpc0F0dHJpYnV0ZXMocGFyc2VkQXR0cmlidXRlcykgPyBwYXJzZWRBdHRyaWJ1dGVzIDogdW5kZWZpbmVkO1xuICAgIH1cbiAgfVxuICBcbiAgLyoqXG4gICAqIEdldHMgdGhlIEZJIGF0dHJpYnV0ZXMgZnJvbSB0aGUgZ2l2ZW4gY29udGV4dFxuICAgKiBAcGFyYW0gY29udGV4dFxuICAgKiBAZXhhbXBsZSBzcGFuLnNldEF0dHJpYnV0ZXMoZ2V0QXR0cmlidXRlc0Zyb21Db250ZXh0KGNvbnRleHQuYWN0aXZlKCkpKTtcbiAgICogQHJldHVybnMge0F0dHJpYnV0ZXN9IFRoZSBGSSBhdHRyaWJ1dGVzIGZvcm1hdHRlZCBhcyBPcGVuVGVsZW1ldHJ5IHNwYW4gYXR0cmlidXRlcy5cbiAgICovXG4gIGV4cG9ydCBmdW5jdGlvbiBnZXRBdHRyaWJ1dGVzRnJvbUNvbnRleHQoY29udGV4dDogQ29udGV4dCk6IEF0dHJpYnV0ZXMge1xuICAgIGxldCBhdHRyaWJ1dGVzOiBBdHRyaWJ1dGVzID0ge307XG4gICAgT2JqZWN0LmVudHJpZXMoQ29udGV4dEF0dHJpYnV0ZXMpLmZvckVhY2goKFtrZXksIHN5bWJvbF0pID0+IHtcbiAgICAgIGNvbnN0IG1heWJlVmFsdWUgPSBjb250ZXh0LmdldFZhbHVlKHN5bWJvbCk7XG4gICAgICBpZiAoa2V5ID09PSBDT05URVhUX0FUVFJJQlVURVNfQVRUUklCVVRFU19LRVkpIHtcbiAgICAgICAgaWYgKHR5cGVvZiBtYXliZVZhbHVlID09PSBcInN0cmluZ1wiKSB7XG4gICAgICAgICAgY29uc3QgcGFyc2VkQXR0cmlidXRlcyA9IHNhZmVseUpTT05QYXJzZShtYXliZVZhbHVlKTtcbiAgICAgICAgICBpZiAoaXNBdHRyaWJ1dGVzKHBhcnNlZEF0dHJpYnV0ZXMpKSB7XG4gICAgICAgICAgICBhdHRyaWJ1dGVzID0geyAuLi5hdHRyaWJ1dGVzLCAuLi5wYXJzZWRBdHRyaWJ1dGVzIH07XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIHJldHVybjtcbiAgICAgIH1cbiAgXG4gICAgICBpZiAoaXNBdHRyaWJ1dGVWYWx1ZShtYXliZVZhbHVlKSAmJiBtYXliZVZhbHVlICE9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgYXR0cmlidXRlc1trZXldID0gbWF5YmVWYWx1ZTtcbiAgICAgIH1cbiAgICB9KTtcbiAgICByZXR1cm4gYXR0cmlidXRlcztcbiAgfSJdfQ==